<!DOCTYPE html>
<html lang="en">
<!-- Base HTML File written by Enes Berk Sakalli-->

<head>

  <head>
    <!-- Sets the character encoding for the document to UTF-8 -->
    <meta charset="utf-8" />

    <!-- The title of the document that appears in the title bar or tab of the browser -->
    <title>Phylo-Cello-Cartography</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="A brief description of your page." />
    <link rel="icon" href="favicon.ico" />

    <!-- Link to the external CSS file to style the document -->
    <link rel="stylesheet" href="../static/css/style.css" />

    <!-- Link to the D3.js library, which is a JavaScript library for creating dynamic and interactive data visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Link to the UIkit CSS library for styling and layout -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.15.22/dist/css/uikit.min.css" />

    <!-- Link to the UIkit JavaScript library for interactive elements -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.15.22/dist/js/uikit.min.js"></script>
    <!-- Link to the UIkit Icon library to enable use of various icons in the UI -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.15.22/dist/js/uikit-icons.min.js"></script>

    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/umap-js@1.3.3/lib/umap-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-prim@3.2.4"></script>    
  </head>
</head>

<body>
  <div class="container">
    <!-- This is the beginning of the Color Section-->
    <div id="color-section"></div>
    <!-- This is the end of the Color Section-->

    <!-- This is the beginning of the Application Container-->

    <div style="width: 95%; height: 95%">
      <svg id="application-container" width="100%" height="95%" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">>
        <g id="application"></g>
      </svg>
    </div>
    <!-- This is the end of the Application Container-->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/hull.js@1.0.0/dist/hull.min.js"></script>

    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
    <script src="../static/js/winbox.min.js"></script>
    <link href="../static/css/winbox.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script type="module">
      import constructTree from "./layouts/circular/TreeConstructor.js";

      // Sample data: an array of points
      import {
        createAndAddTreeElementsToScene,
        initializeNodeSelectionAndHighlighting,
        initializeTreeDimensionPlot,
      } from "./layouts/circular/treeIndex.js"


      import {
        CosmosController,
        animateUniverse
      } from "./Cosmos.js"

      import {
        storeData,
        getData,
        openDatabase,
        deepCopyJSON,
        deleteData
      } from "./nebulaDB.js";

      
      import { 
        initializeFoldedTrailGraph, 
        initializeTrailGraph, 
        createTrailGraphLayout,
      } from "./forceTrailGraphs.js"


      import {
        createStatisticsWindowAndWriteContent,
      } from "./statisticsWindow.js"

      import {
        initializeCtGraphUniverse,
        calculateMonophyleticCladesCtGraph,
        createCtUniverseGraph
      } from "./layouts/ct-graph/cellTypeGraph.js"

      import { createTrailTopologyMinimalSpanningTree, createTrailTopologyWithConcaveHulls} from "./minimalSpanningTree.js"
      import { initializeDimensionalityReductionPlot } from "./dimensionalityReductionPlotter.js"
      import { sortTreeByGroup, assignUniqueIds } from "./collapseRadialTree.js"
      import {createTrailDelaunayMeshesForTree} from "./createDelaunayConnections.js"


      // Assuming you have an array of file names
      var files = [
      "../test/julia/julia_pancreas.json",
      "../test/random_generated_tree_circle_simulation_new_060424.json",
      "../test/random_generated_tree.json",
      "../test/random_generated_tree_circle_simulation_new.json",     
      "../test/random_generated_tree_3.json",      
      "../test/random_generated_tree_circle_simulation.json",
      "../test/random_generated_tree150123.json",
      ];

      // Create an object to hold the selected file
      var chosenFile = {
        selectedFile: files[0] // default selection
      };

      // Create a new dat.GUI instance
      var gui = new dat.GUI();

      // Add a dropdown list to the GUI
      gui.add(chosenFile, 'selectedFile', files).name('Choose File').onChange(function (newValue) {
        // This function will be called whenever the user selects a new file
        console.log('User selected:', newValue);
        // Call the main function to run the code
        main(newValue);
        // You can add your code here to handle the file selection
      });

      // Place the GUI on the page
      document.body.appendChild(gui.domElement);
      
      // Main function to handle the data loading and visualization
      async function main(file_name) {
        try {

          function createDirectlyForceTrailGraph(cosmos, tree, colorScale){
                let TRAIL_GRAPH_ID = 'trail-graph-id';
                calculateFoldedTrailTopology(tree)
                initializeTrailGraph(cosmos, tree, colorScale, TRAIL_GRAPH_ID, '50%', '100%', '50%', '0%');
                animateUniverse(cosmos.getUniverseById(TRAIL_GRAPH_ID));
          }

          function createFoldedTrailGraph(cosmos, treeData, colorScale, statistics){
            let FOLDED_FORCE_TRAIL_GRAPH_ID = 'union-force-trail-graph-id';
            let unionTree = constructTree(deepCopyJSON(treeData), false, 'application-container');
            let windowParameter = {
              windowWidth: "50%",
              windowHeight: "50%",
              windowTop: "0%",
              windowLeft: "0%"
            }
            initializeFoldedTrailGraph(cosmos, unionTree, colorScale, FOLDED_FORCE_TRAIL_GRAPH_ID, windowParameter,  createTrailTopologyMinimalSpanningTree, statistics);       
            animateUniverse(cosmos.getUniverseById(FOLDED_FORCE_TRAIL_GRAPH_ID));
          }

          function radialTreePlot(cosmos, tree, colorScale){
            let treeUniverseId = 'tree-plot';
            let direction = "left";
            initializeTreeDimensionPlot(cosmos, treeUniverseId, direction);
            createAndAddTreeElementsToScene(tree, cosmos, treeUniverseId, colorScale);
            animateUniverse(cosmos.getUniverseById(treeUniverseId));
            initializeNodeSelectionAndHighlighting(cosmos, colorScale, treeUniverseId);  
          }

          function createCollapsedRadialTree(cosmos, tree, colorScale){
            collapseTree(tree);
            let collapsedTreeUniverseId = 'collapsed-tree-plot';
            initializeTreeDimensionPlot(cosmos, collapsedTreeUniverseId);
            createAndAddCollapsedTreeElementsToScene(tree, collapsedTreeUniverseId, cosmos, colorScale);
            animateUniverse(cosmos.getUniverseById(collapsedTreeUniverseId));
          }

          function createDimensionalityReductionPlot(){
              let POINT_CLOUD_ID = 'dimensionality-reduction-plot';
              initializeDimensionalityReductionPlot(cosmos, nodes, colorScale, POINT_CLOUD_ID);
              animateUniverse(cosmos.getUniverseById(POINT_CLOUD_ID));
          }

          function createCellTypeGraph(treeData, colorScale){
            let ctgraphUniverse= "ct-graph-universe"
            initializeCtGraphUniverse(ctgraphUniverse)
            let ctTree = constructTree(deepCopyJSON(treeData), false, 'application-container');
            calculateMonophyleticCladesCtGraph(ctTree)
            createCtUniverseGraph(ctTree, ctgraphUniverse, colorScale)  
          }          
          
          function createColorScale(groups){
            const colorScale = d3.scaleOrdinal()
            .domain(d3.range(groups[groups.length - 1] + 1))
            .range(d3.schemeTableau10);
            return colorScale
          }

          
          const db = await openDatabase();

          deleteData(db, 'random_generated_tree');
          deleteData(db, 'random_generated_tree_msa');

          // Try to get the tree data from IndexedDB
          let treeData = await getData(db, 'random_generated_tree');
          
          if (!treeData) {            
            // Data not found, fetch it from the server
            treeData = await d3.json(file_name);
            await storeData(db, 'random_generated_tree', treeData);
          }

          // Try to get the MSA data from IndexedDB
          let msaData = await getData(db, 'random_generated_tree_msa');

          if (!msaData) {
            // MSA data not found, fetch it from the server
            msaData = await d3.json("../test/random_generated_tree.json");
            await storeData(db, 'random_generated_tree_msa', msaData);
          }

          // Now you have both treeData and msaData, you can proceed with your visualization
          let width = window.innerWidth;
          let height = window.innerHeight;

          sortTreeByGroup(treeData);
          let tree = constructTree(deepCopyJSON(treeData), false, 'application-container');
          await storeData(db, 'functional_tree', tree);
          assignUniqueIds(tree);
          let colorScale = createColorScale(treeData.groups);

          d3.select("#application").attr(
            'transform',
            `translate(${width / 2}, ${height / 2})`
          );

          var cosmos = new CosmosController();
          createCellTypeGraph(treeData, colorScale)
          let statistics = createStatisticsWindowAndWriteContent(treeData, colorScale)
          createFoldedTrailGraph(cosmos, treeData, colorScale, statistics);
          radialTreePlot(cosmos, tree,colorScale)
          
        } catch (error) {
          console.error('An error occurred:', error);
        }
      }

      main(chosenFile.selectedFile);

    </script>


</body>

</html>